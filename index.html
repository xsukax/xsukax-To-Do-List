<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>xsukax To-Do List</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        .icon-check::before { content: '‚úì'; font-size: 14px; font-weight: bold; }
        .icon-plus::before { content: '+'; font-size: 16px; font-weight: bold; }
        .icon-close::before { content: '√ó'; font-size: 24px; font-weight: 300; }
        .icon-edit::before { content: '‚úé'; font-size: 18px; }
        .icon-delete::before { content: 'üóë'; font-size: 16px; }
        .icon-search-clear::before { content: '√ó'; font-size: 20px; }
        .icon-doc::before { content: 'üìÑ'; font-size: 20px; }
        .github-shadow { box-shadow: 0 1px 0 rgba(27,31,35,0.04), inset 0 1px 0 hsla(0,0%,100%,0.25); }
        .github-border { border-color: rgba(27,31,35,0.15); }
        .github-btn { background-color: #fafbfc; background-image: linear-gradient(180deg,#fafbfc,#eff3f6); border: 1px solid rgba(27,31,35,0.15); transition: all 0.2s; }
        .github-btn:hover { background-color: #f3f4f6; background-image: linear-gradient(180deg,#f3f4f6,#e9ecef); border-color: rgba(27,31,35,0.25); }
        .github-btn-primary { background-color: #2ea44f; background-image: linear-gradient(180deg,#2ea44f,#298e46); border-color: rgba(27,31,35,0.15); color: white; }
        .github-btn-primary:hover { background-color: #2c974b; background-image: linear-gradient(180deg,#2c974b,#279f46); }
        .task-card { border: 1px solid #d0d7de; border-radius: 6px; background: white; transition: box-shadow 0.2s; }
        .task-card:hover { box-shadow: 0 3px 8px rgba(27,31,35,0.12); }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div id="app" class="container mx-auto px-4 py-8 max-w-5xl">
        <!-- Header -->
        <header class="flex flex-col md:flex-row md:justify-between md:items-center mb-8 gap-4">
            <div class="flex items-center space-x-3">
                <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg flex items-center justify-center text-white text-xl font-bold shadow-md">X</div>
                <h1 class="text-3xl font-bold text-gray-900">xsukax To-Do List</h1>
            </div>
            <div class="flex space-x-2">
                <button id="importBtn" class="github-btn px-4 py-2 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50 transition-colors flex items-center gap-2">
                    <span class="icon-doc"></span>Import
                </button>
                <button id="exportBtn" class="github-btn px-4 py-2 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50 transition-colors flex items-center gap-2">
                    <span class="icon-doc"></span>Export
                </button>
                <button id="shareBtn" class="github-btn-primary px-4 py-2 rounded-md text-sm font-medium transition-colors">Share URL</button>
            </div>
        </header>

        <!-- Task Input -->
        <div class="task-card p-4 mb-6 shadow-sm">
            <div class="flex items-start space-x-3">
                <button id="addTaskBtn" class="mt-1 w-6 h-6 rounded-full border-2 github-border flex items-center justify-center hover:border-blue-500 transition-colors text-gray-400">
                    <span class="icon-plus"></span>
                </button>
                <input type="text" id="taskInput" placeholder="Add a new task..." class="flex-1 py-2 px-3 border-0 focus:outline-none focus:ring-0 text-base bg-transparent">
                <button id="quickAddBtn" class="github-btn-primary px-4 py-2 rounded-md text-sm font-medium transition-colors">Add</button>
            </div>
            <div id="taskDetails" class="mt-4 hidden space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Due Date</label>
                        <input type="datetime-local" id="taskDueDate" class="w-full px-3 py-2 border github-border rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Priority</label>
                        <select id="taskPriority" class="w-full px-3 py-2 border github-border rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="low">Low</option>
                            <option value="medium" selected>Medium</option>
                            <option value="high">High</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Tags (comma separated)</label>
                    <input type="text" id="taskTags" placeholder="work, personal, urgent" class="w-full px-3 py-2 border github-border rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Notes</label>
                    <textarea id="taskNotes" rows="3" class="w-full px-3 py-2 border github-border rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></textarea>
                </div>
                <div class="flex justify-end space-x-2">
                    <button id="cancelTaskBtn" class="github-btn px-4 py-2 rounded-md text-sm font-medium text-gray-700 transition-colors">Cancel</button>
                    <button id="saveTaskBtn" class="github-btn-primary px-4 py-2 rounded-md text-sm font-medium transition-colors">Save Task</button>
                </div>
            </div>
        </div>

        <!-- Task Filters -->
        <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-6 gap-4">
            <div class="flex flex-wrap gap-2">
                <button data-filter="all" class="filter-btn github-btn px-3 py-1.5 rounded-md text-sm font-medium bg-blue-50 text-blue-700 border-blue-300">All</button>
                <button data-filter="today" class="filter-btn github-btn px-3 py-1.5 rounded-md text-sm font-medium text-gray-700">Today</button>
                <button data-filter="upcoming" class="filter-btn github-btn px-3 py-1.5 rounded-md text-sm font-medium text-gray-700">Upcoming</button>
                <button data-filter="completed" class="filter-btn github-btn px-3 py-1.5 rounded-md text-sm font-medium text-gray-700">Completed</button>
            </div>
            <div class="flex items-center space-x-2">
                <label class="flex items-center space-x-2 cursor-pointer">
                    <input type="checkbox" id="showSubtasks" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500 w-4 h-4">
                    <span class="text-sm text-gray-700 whitespace-nowrap">Show Subtasks</span>
                </label>
                <input type="text" id="searchInput" placeholder="Search tasks..." class="px-3 py-1.5 border github-border rounded-md text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 w-full md:w-64">
                <button id="clearSearch" class="p-1 text-gray-400 hover:text-gray-600 transition-colors">
                    <span class="icon-search-clear"></span>
                </button>
            </div>
        </div>

        <!-- Tasks List -->
        <div id="tasksContainer" class="space-y-3"></div>

        <!-- Empty State -->
        <div id="emptyState" class="text-center py-16 hidden">
            <div class="text-6xl mb-4">üìù</div>
            <h3 class="text-xl font-semibold text-gray-700 mb-2">No tasks yet</h3>
            <p class="text-gray-500">Get started by creating your first task above.</p>
        </div>
    </div>

    <!-- Notification Overlay -->
    <div id="notification" class="fixed top-4 right-4 bg-green-600 text-white px-4 py-3 rounded-md shadow-lg transition-all duration-300 transform translate-x-full max-w-sm z-50">
        <div class="flex items-center space-x-2">
            <span class="text-xl">‚úì</span>
            <span id="notificationText" class="text-sm font-medium">Operation completed successfully</span>
        </div>
    </div>

    <!-- Import Modal -->
    <div id="importModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full">
            <div class="px-6 py-4 border-b github-border">
                <h3 class="text-lg font-semibold text-gray-900">Import Tasks</h3>
            </div>
            <div class="px-6 py-4">
                <p class="text-sm text-gray-600 mb-4">Select a JSON file to import your tasks</p>
                <div class="border-2 border-dashed github-border rounded-lg p-8 text-center hover:border-blue-400 transition-colors">
                    <div class="text-4xl mb-3">üìÅ</div>
                    <label for="importFile" class="github-btn-primary px-4 py-2 rounded-md text-sm font-medium transition-colors cursor-pointer inline-block">
                        Choose JSON File
                    </label>
                    <input type="file" id="importFile" accept=".json,application/json" class="hidden">
                    <p id="selectedFileName" class="text-sm text-gray-500 mt-3">No file selected</p>
                </div>
            </div>
            <div class="px-6 py-4 border-t github-border flex justify-end space-x-3">
                <button id="cancelImport" class="github-btn px-4 py-2 rounded-md text-sm font-medium text-gray-700 transition-colors">Cancel</button>
                <button id="confirmImport" class="github-btn-primary px-4 py-2 rounded-md text-sm font-medium transition-colors" disabled>Import</button>
            </div>
        </div>
    </div>

    <!-- Share Modal -->
    <div id="shareModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full">
            <div class="px-6 py-4 border-b github-border">
                <h3 class="text-lg font-semibold text-gray-900">Share Task List</h3>
            </div>
            <div class="px-6 py-4 space-y-4">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Encoding Method</label>
                    <div class="space-y-2">
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="radio" name="shareMethod" value="encrypted" checked class="w-4 h-4 text-blue-600 focus:ring-blue-500">
                            <span class="text-sm text-gray-700">AES-256 Encrypted (requires password)</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="radio" name="shareMethod" value="base64" class="w-4 h-4 text-blue-600 focus:ring-blue-500">
                            <span class="text-sm text-gray-700">Base64 Encoded (no password)</span>
                        </label>
                    </div>
                </div>
                <div id="passwordSection">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Encryption Password</label>
                    <input type="password" id="sharePassword" class="w-full px-3 py-2 border github-border rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Enter a strong password">
                </div>
                <div id="urlSection" class="hidden">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Shareable URL</label>
                    <div class="flex space-x-2 mb-2">
                        <input type="text" id="shareUrl" readonly class="flex-1 px-3 py-2 border github-border rounded-md bg-gray-50 text-gray-600 text-sm">
                        <button id="copyUrlBtn" class="github-btn-primary px-4 py-2 rounded-md text-sm font-medium transition-colors whitespace-nowrap">Copy</button>
                    </div>
                    <button id="openUrlBtn" class="github-btn w-full px-4 py-2 rounded-md text-sm font-medium text-gray-700 transition-colors">Open URL in New Tab</button>
                </div>
                <div class="flex justify-end">
                    <button id="generateUrlBtn" class="github-btn-primary px-4 py-2 rounded-md text-sm font-medium transition-colors">Generate URL</button>
                </div>
            </div>
            <div class="px-6 py-4 border-t github-border flex justify-end">
                <button id="closeShareModal" class="github-btn px-4 py-2 rounded-md text-sm font-medium text-gray-700 transition-colors">Close</button>
            </div>
        </div>
    </div>

    <!-- Decrypt Modal -->
    <div id="decryptModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full">
            <div class="px-6 py-4 border-b github-border">
                <h3 class="text-lg font-semibold text-gray-900">Load Shared List</h3>
            </div>
            <div class="px-6 py-4">
                <p class="text-gray-600 mb-4 text-sm" id="decryptMessage">This URL contains an encrypted task list. Enter the password to decrypt it.</p>
                <div id="decryptPasswordSection">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Password</label>
                    <input type="password" id="decryptPassword" class="w-full px-3 py-2 border github-border rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Enter the password">
                </div>
            </div>
            <div class="px-6 py-4 border-t github-border flex justify-end space-x-3">
                <button id="cancelDecrypt" class="github-btn px-4 py-2 rounded-md text-sm font-medium text-gray-700 transition-colors">Cancel</button>
                <button id="confirmDecrypt" class="github-btn-primary px-4 py-2 rounded-md text-sm font-medium transition-colors">Load Tasks</button>
            </div>
        </div>
    </div>

    <!-- Task Detail Modal -->
    <div id="taskDetailModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="px-6 py-4 border-b github-border flex justify-between items-center">
                <h3 class="text-lg font-semibold text-gray-900">Task Details</h3>
                <button id="closeTaskModal" class="text-gray-400 hover:text-gray-600 transition-colors">
                    <span class="icon-close"></span>
                </button>
            </div>
            <div class="px-6 py-4 space-y-4">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Title</label>
                    <input type="text" id="detailTitle" class="w-full px-3 py-2 border github-border rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-base font-medium">
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Due Date</label>
                        <input type="datetime-local" id="detailDueDate" class="w-full px-3 py-2 border github-border rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Priority</label>
                        <select id="detailPriority" class="w-full px-3 py-2 border github-border rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="low">Low</option>
                            <option value="medium">Medium</option>
                            <option value="high">High</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Tags</label>
                    <input type="text" id="detailTags" class="w-full px-3 py-2 border github-border rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="work, personal, urgent">
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Notes</label>
                    <textarea id="detailNotes" rows="5" class="w-full px-3 py-2 border github-border rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></textarea>
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-3">Subtasks</label>
                    <div id="subtasksContainer" class="space-y-2 mb-3"></div>
                    <div class="flex space-x-2">
                        <input type="text" id="newSubtask" placeholder="Add a subtask" class="flex-1 px-3 py-2 border github-border rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <button id="addSubtaskBtn" class="github-btn-primary px-4 py-2 rounded-md text-sm font-medium transition-colors">Add</button>
                    </div>
                </div>
            </div>
            <div class="px-6 py-4 border-t github-border flex justify-between">
                <button id="deleteTaskBtn" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-md text-sm font-medium transition-colors">Delete Task</button>
                <div class="flex space-x-3">
                    <button id="cancelTaskDetail" class="github-btn px-4 py-2 rounded-md text-sm font-medium text-gray-700 transition-colors">Cancel</button>
                    <button id="saveTaskDetail" class="github-btn-primary px-4 py-2 rounded-md text-sm font-medium transition-colors">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const state = {
            tasks: JSON.parse(localStorage.getItem('xsukax-tasks')) || [],
            currentFilter: 'all',
            searchQuery: '',
            editingTaskId: null,
            showSubtasks: JSON.parse(localStorage.getItem('xsukax-show-subtasks')) || false
        };

        const el = {
            taskInput: document.getElementById('taskInput'),
            tasksContainer: document.getElementById('tasksContainer'),
            emptyState: document.getElementById('emptyState'),
            notification: document.getElementById('notification'),
            notificationText: document.getElementById('notificationText'),
            importModal: document.getElementById('importModal'),
            exportBtn: document.getElementById('exportBtn'),
            importBtn: document.getElementById('importBtn'),
            shareBtn: document.getElementById('shareBtn'),
            shareModal: document.getElementById('shareModal'),
            decryptModal: document.getElementById('decryptModal'),
            taskDetailModal: document.getElementById('taskDetailModal'),
            filterBtns: document.querySelectorAll('.filter-btn'),
            searchInput: document.getElementById('searchInput'),
            clearSearch: document.getElementById('clearSearch'),
            addTaskBtn: document.getElementById('addTaskBtn'),
            quickAddBtn: document.getElementById('quickAddBtn'),
            taskDetails: document.getElementById('taskDetails'),
            cancelTaskBtn: document.getElementById('cancelTaskBtn'),
            saveTaskBtn: document.getElementById('saveTaskBtn'),
            taskDueDate: document.getElementById('taskDueDate'),
            taskPriority: document.getElementById('taskPriority'),
            taskTags: document.getElementById('taskTags'),
            taskNotes: document.getElementById('taskNotes')
        };

        function init() {
            setupEventListeners();
            checkForSharedData();
            document.getElementById('showSubtasks').checked = state.showSubtasks;
            renderTasks();
        }

        function setupEventListeners() {
            el.addTaskBtn.addEventListener('click', toggleTaskDetails);
            el.quickAddBtn.addEventListener('click', handleQuickAdd);
            el.cancelTaskBtn.addEventListener('click', resetTaskForm);
            el.saveTaskBtn.addEventListener('click', handleSaveTask);
            el.taskInput.addEventListener('keypress', e => e.key === 'Enter' && handleQuickAdd());

            el.filterBtns.forEach(btn => btn.addEventListener('click', e => setFilter(e.target.dataset.filter)));
            el.searchInput.addEventListener('input', e => { state.searchQuery = e.target.value; renderTasks(); });
            el.clearSearch.addEventListener('click', () => { el.searchInput.value = ''; state.searchQuery = ''; renderTasks(); });
            document.getElementById('showSubtasks').addEventListener('change', e => {
                state.showSubtasks = e.target.checked;
                localStorage.setItem('xsukax-show-subtasks', JSON.stringify(state.showSubtasks));
                renderTasks();
            });

            el.importBtn.addEventListener('click', showImportModal);
            el.exportBtn.addEventListener('click', handleExport);
            document.getElementById('cancelImport').addEventListener('click', () => el.importModal.classList.add('hidden'));
            document.getElementById('importFile').addEventListener('change', handleFileSelect);
            document.getElementById('confirmImport').addEventListener('click', handleImport);

            el.shareBtn.addEventListener('click', showShareModal);
            document.getElementById('closeShareModal').addEventListener('click', () => el.shareModal.classList.add('hidden'));
            document.getElementById('generateUrlBtn').addEventListener('click', generateShareUrl);
            document.getElementById('copyUrlBtn').addEventListener('click', copyShareUrl);
            document.getElementById('openUrlBtn').addEventListener('click', openShareUrl);
            
            document.querySelectorAll('input[name="shareMethod"]').forEach(radio => {
                radio.addEventListener('change', updateShareMethod);
            });

            document.getElementById('cancelDecrypt').addEventListener('click', () => {
                el.decryptModal.classList.add('hidden');
                window.location.hash = '';
            });
            document.getElementById('confirmDecrypt').addEventListener('click', handleDecrypt);

            document.getElementById('closeTaskModal').addEventListener('click', () => el.taskDetailModal.classList.add('hidden'));
            document.getElementById('cancelTaskDetail').addEventListener('click', () => el.taskDetailModal.classList.add('hidden'));
            document.getElementById('saveTaskDetail').addEventListener('click', saveTaskDetails);
            document.getElementById('deleteTaskBtn').addEventListener('click', deleteCurrentTask);
            document.getElementById('addSubtaskBtn').addEventListener('click', addSubtask);
            document.getElementById('newSubtask').addEventListener('keypress', e => e.key === 'Enter' && addSubtask());
        }

        function toggleTaskDetails() {
            el.taskDetails.classList.toggle('hidden');
            if (!el.taskDetails.classList.contains('hidden')) el.taskInput.focus();
        }

        function handleQuickAdd() {
            const title = el.taskInput.value.trim();
            if (!title) return;

            state.tasks.unshift({
                id: Date.now().toString(),
                title,
                completed: false,
                createdAt: new Date().toISOString(),
                priority: 'medium',
                tags: [],
                subtasks: [],
                notes: ''
            });

            saveTasks();
            renderTasks();
            el.taskInput.value = '';
            showNotification('Task added successfully');
        }

        function resetTaskForm() {
            el.taskInput.value = '';
            el.taskDueDate.value = '';
            el.taskPriority.value = 'medium';
            el.taskTags.value = '';
            el.taskNotes.value = '';
            el.taskDetails.classList.add('hidden');
        }

        function handleSaveTask() {
            const title = el.taskInput.value.trim();
            if (!title) {
                showNotification('Please enter a task title', 'error');
                return;
            }

            const tags = el.taskTags.value.split(',').map(t => t.trim()).filter(t => t);

            state.tasks.unshift({
                id: Date.now().toString(),
                title,
                completed: false,
                createdAt: new Date().toISOString(),
                dueDate: el.taskDueDate.value || null,
                priority: el.taskPriority.value,
                tags,
                subtasks: [],
                notes: el.taskNotes.value
            });

            saveTasks();
            renderTasks();
            resetTaskForm();
            showNotification('Task added successfully');
        }

        function setFilter(filter) {
            state.currentFilter = filter;
            el.filterBtns.forEach(btn => {
                if (btn.dataset.filter === filter) {
                    btn.classList.add('bg-blue-50', 'text-blue-700', 'border-blue-300');
                } else {
                    btn.classList.remove('bg-blue-50', 'text-blue-700', 'border-blue-300');
                }
            });
            renderTasks();
        }

        function renderTasks() {
            let filtered = [...state.tasks];

            if (state.searchQuery) {
                const q = state.searchQuery.toLowerCase();
                filtered = filtered.filter(t => 
                    t.title.toLowerCase().includes(q) || 
                    t.tags.some(tag => tag.toLowerCase().includes(q)) ||
                    (t.notes && t.notes.toLowerCase().includes(q))
                );
            }

            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());

            switch (state.currentFilter) {
                case 'today':
                    filtered = filtered.filter(t => {
                        if (!t.dueDate || t.completed) return false;
                        const due = new Date(t.dueDate);
                        const dueDay = new Date(due.getFullYear(), due.getMonth(), due.getDate());
                        return dueDay.getTime() === today.getTime();
                    });
                    break;
                case 'upcoming':
                    filtered = filtered.filter(t => {
                        if (!t.dueDate || t.completed) return false;
                        return new Date(t.dueDate) > now;
                    });
                    break;
                case 'completed':
                    filtered = filtered.filter(t => t.completed);
                    break;
            }

            filtered.sort((a, b) => {
                if (a.completed && !b.completed) return 1;
                if (!a.completed && b.completed) return -1;
                if (a.dueDate && !b.dueDate) return -1;
                if (!a.dueDate && b.dueDate) return 1;
                if (a.dueDate && b.dueDate) {
                    const diff = new Date(a.dueDate) - new Date(b.dueDate);
                    if (diff !== 0) return diff;
                }
                return new Date(b.createdAt) - new Date(a.createdAt);
            });

            if (filtered.length === 0) {
                el.tasksContainer.innerHTML = '';
                el.emptyState.classList.remove('hidden');
            } else {
                el.emptyState.classList.add('hidden');
                el.tasksContainer.innerHTML = filtered.map(renderTask).join('');
                filtered.forEach(attachTaskListeners);
            }
        }

        function renderTask(task) {
            const dueDate = task.dueDate ? new Date(task.dueDate) : null;
            const isOverdue = dueDate && dueDate < new Date() && !task.completed;
            
            return `
                <div id="task-${task.id}" class="task-card p-4 ${task.completed ? 'opacity-60' : ''}">
                    <div class="flex items-start justify-between">
                        <div class="flex items-start space-x-3 flex-1">
                            <button class="complete-btn mt-1 w-5 h-5 rounded-full border-2 ${task.completed ? 'bg-green-500 border-green-500 text-white' : 'github-border'} flex items-center justify-center hover:border-green-500 transition-colors">
                                ${task.completed ? '<span class="icon-check text-white"></span>' : ''}
                            </button>
                            <div class="flex-1 min-w-0">
                                <h3 class="font-medium text-gray-900 ${task.completed ? 'line-through text-gray-500' : ''} break-words">${escapeHtml(task.title)}</h3>
                                <div class="flex flex-wrap items-center mt-2 gap-2">
                                    ${dueDate ? `<span class="text-xs px-2 py-1 rounded-md ${isOverdue ? 'bg-red-100 text-red-800' : 'bg-gray-100 text-gray-700'}">${formatDate(dueDate)}</span>` : ''}
                                    ${task.priority === 'high' ? '<span class="text-xs px-2 py-1 rounded-md bg-red-100 text-red-800 font-medium">High Priority</span>' : ''}
                                    ${task.priority === 'low' ? '<span class="text-xs px-2 py-1 rounded-md bg-blue-100 text-blue-800 font-medium">Low Priority</span>' : ''}
                                    ${task.tags.map(tag => `<span class="text-xs px-2 py-1 rounded-md bg-gray-100 text-gray-700">${escapeHtml(tag)}</span>`).join('')}
                                </div>
                                ${task.notes ? `<p class="text-sm text-gray-600 mt-2 break-words">${escapeHtml(task.notes)}</p>` : ''}
                                ${state.showSubtasks && task.subtasks?.length ? `
                                    <div class="mt-3 space-y-1.5 pl-2 border-l-2 border-gray-200">
                                        ${task.subtasks.map((st, idx) => `
                                            <div class="flex items-center space-x-2 text-sm">
                                                <input type="checkbox" ${st.completed ? 'checked' : ''} 
                                                       class="subtask-checkbox rounded border-gray-300 text-blue-600 focus:ring-blue-500 w-3.5 h-3.5" 
                                                       data-task-id="${task.id}" data-subtask-index="${idx}">
                                                <span class="${st.completed ? 'line-through text-gray-400' : 'text-gray-700'}">${escapeHtml(st.title)}</span>
                                            </div>
                                        `).join('')}
                                    </div>
                                ` : !state.showSubtasks && task.subtasks?.length ? `
                                    <div class="mt-2 text-sm text-gray-500">
                                        ${task.subtasks.filter(st => st.completed).length} of ${task.subtasks.length} subtasks completed
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                        <div class="flex space-x-1 ml-3 flex-shrink-0">
                            <button class="edit-btn p-1.5 text-gray-400 hover:text-blue-600 transition-colors"><span class="icon-edit"></span></button>
                            <button class="delete-btn p-1.5 text-gray-400 hover:text-red-600 transition-colors"><span class="icon-delete"></span></button>
                        </div>
                    </div>
                </div>
            `;
        }

        function attachTaskListeners(task) {
            const elem = document.getElementById(`task-${task.id}`);
            if (!elem) return;
            elem.querySelector('.complete-btn').addEventListener('click', () => toggleTaskComplete(task.id));
            elem.querySelector('.edit-btn').addEventListener('click', () => openTaskDetail(task.id));
            elem.querySelector('.delete-btn').addEventListener('click', () => deleteTask(task.id));
            
            // Add listeners for subtask checkboxes if they're visible
            if (state.showSubtasks) {
                elem.querySelectorAll('.subtask-checkbox').forEach(checkbox => {
                    checkbox.addEventListener('change', (e) => {
                        const taskId = e.target.dataset.taskId;
                        const subtaskIndex = parseInt(e.target.dataset.subtaskIndex);
                        toggleSubtaskFromHome(taskId, subtaskIndex);
                    });
                });
            }
        }

        function toggleTaskComplete(id) {
            const task = state.tasks.find(t => t.id === id);
            if (task) {
                task.completed = !task.completed;
                saveTasks();
                renderTasks();
                showNotification(`Task ${task.completed ? 'completed' : 'reopened'}`);
            }
        }

        function toggleSubtaskFromHome(taskId, subtaskIndex) {
            const task = state.tasks.find(t => t.id === taskId);
            if (task?.subtasks?.[subtaskIndex]) {
                task.subtasks[subtaskIndex].completed = !task.subtasks[subtaskIndex].completed;
                saveTasks();
                renderTasks();
                showNotification('Subtask updated');
            }
        }

        function openTaskDetail(id) {
            const task = state.tasks.find(t => t.id === id);
            if (!task) return;
            state.editingTaskId = id;
            document.getElementById('detailTitle').value = task.title;
            document.getElementById('detailDueDate').value = task.dueDate ? formatDateForInput(new Date(task.dueDate)) : '';
            document.getElementById('detailPriority').value = task.priority;
            document.getElementById('detailTags').value = task.tags.join(', ');
            document.getElementById('detailNotes').value = task.notes || '';
            renderSubtasks(task.subtasks || []);
            el.taskDetailModal.classList.remove('hidden');
        }

        function renderSubtasks(subtasks) {
            const container = document.getElementById('subtasksContainer');
            if (!subtasks?.length) {
                container.innerHTML = '<p class="text-gray-500 text-sm">No subtasks yet</p>';
                return;
            }
            container.innerHTML = subtasks.map((st, i) => `
                <div class="flex items-center space-x-2 p-2 bg-gray-50 rounded-md">
                    <input type="checkbox" ${st.completed ? 'checked' : ''} onchange="toggleSubtask(${i})" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500 w-4 h-4">
                    <input type="text" value="${escapeHtml(st.title)}" class="flex-1 px-2 py-1 border github-border rounded text-sm focus:ring-2 focus:ring-blue-500 ${st.completed ? 'line-through text-gray-500' : ''}" onchange="updateSubtaskTitle(${i}, this.value)">
                    <button onclick="deleteSubtask(${i})" class="text-red-500 hover:text-red-700 p-1"><span class="icon-delete"></span></button>
                </div>
            `).join('');
        }

        function addSubtask() {
            const input = document.getElementById('newSubtask');
            const title = input.value.trim();
            if (!title) return;
            const task = state.tasks.find(t => t.id === state.editingTaskId);
            if (!task) return;
            if (!task.subtasks) task.subtasks = [];
            task.subtasks.push({ title, completed: false });
            saveTasks();
            renderSubtasks(task.subtasks);
            input.value = '';
        }

        function saveTaskDetails() {
            const task = state.tasks.find(t => t.id === state.editingTaskId);
            if (!task) return;
            task.title = document.getElementById('detailTitle').value.trim();
            task.dueDate = document.getElementById('detailDueDate').value || null;
            task.priority = document.getElementById('detailPriority').value;
            task.tags = document.getElementById('detailTags').value.split(',').map(t => t.trim()).filter(t => t);
            task.notes = document.getElementById('detailNotes').value;
            saveTasks();
            renderTasks();
            el.taskDetailModal.classList.add('hidden');
            showNotification('Task updated successfully');
        }

        function deleteCurrentTask() {
            if (confirm('Are you sure you want to delete this task?')) {
                deleteTask(state.editingTaskId);
                el.taskDetailModal.classList.add('hidden');
            }
        }

        function deleteTask(id) {
            state.tasks = state.tasks.filter(t => t.id !== id);
            saveTasks();
            renderTasks();
            showNotification('Task deleted successfully');
        }

        function showImportModal() {
            el.importModal.classList.remove('hidden');
            document.getElementById('importFile').value = '';
            document.getElementById('selectedFileName').textContent = 'No file selected';
            document.getElementById('confirmImport').disabled = true;
        }

        let importedData = null;

        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (!file) {
                document.getElementById('selectedFileName').textContent = 'No file selected';
                document.getElementById('confirmImport').disabled = true;
                importedData = null;
                return;
            }

            if (!file.name.endsWith('.json')) {
                showNotification('Please select a JSON file', 'error');
                document.getElementById('selectedFileName').textContent = 'Invalid file type';
                document.getElementById('confirmImport').disabled = true;
                importedData = null;
                return;
            }

            document.getElementById('selectedFileName').textContent = file.name;
            
            const reader = new FileReader();
            reader.onload = function(event) {
                try {
                    importedData = JSON.parse(event.target.result);
                    document.getElementById('confirmImport').disabled = false;
                } catch (e) {
                    showNotification('Invalid JSON file', 'error');
                    document.getElementById('selectedFileName').textContent = 'Error reading file';
                    document.getElementById('confirmImport').disabled = true;
                    importedData = null;
                }
            };
            reader.onerror = function() {
                showNotification('Error reading file', 'error');
                document.getElementById('selectedFileName').textContent = 'Error reading file';
                document.getElementById('confirmImport').disabled = true;
                importedData = null;
            };
            reader.readAsText(file);
        }

        function handleImport() {
            if (!importedData) {
                showNotification('Please select a file first', 'error');
                return;
            }
            try {
                if (!Array.isArray(importedData)) throw new Error('Data must be an array');
                const existingIds = new Set(state.tasks.map(t => t.id));
                const newTasks = importedData.filter(t => !existingIds.has(t.id));
                state.tasks = [...state.tasks, ...newTasks];
                saveTasks();
                renderTasks();
                el.importModal.classList.add('hidden');
                showNotification(`Imported ${newTasks.length} tasks`);
                importedData = null;
            } catch (e) {
                showNotification('Invalid data: ' + e.message, 'error');
            }
        }

        function handleExport() {
            const data = JSON.stringify(state.tasks, null, 2);
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'xsukax-tasks.json';
            a.click();
            URL.revokeObjectURL(url);
            showNotification('Tasks exported successfully');
        }

        function showShareModal() {
            el.shareModal.classList.remove('hidden');
            document.getElementById('sharePassword').value = '';
            document.getElementById('shareUrl').value = '';
            document.getElementById('urlSection').classList.add('hidden');
            document.querySelector('input[name="shareMethod"][value="encrypted"]').checked = true;
            updateShareMethod();
        }

        function updateShareMethod() {
            const method = document.querySelector('input[name="shareMethod"]:checked').value;
            const passwordSection = document.getElementById('passwordSection');
            if (method === 'encrypted') {
                passwordSection.classList.remove('hidden');
            } else {
                passwordSection.classList.add('hidden');
            }
        }

        function generateShareUrl() {
            const method = document.querySelector('input[name="shareMethod"]:checked').value;
            let encoded;

            if (method === 'encrypted') {
                const password = document.getElementById('sharePassword').value;
                if (!password) {
                    showNotification('Please enter a password', 'error');
                    return;
                }
                encoded = 'enc:' + CryptoJS.AES.encrypt(JSON.stringify(state.tasks), password).toString();
            } else {
                encoded = 'b64:' + btoa(JSON.stringify(state.tasks));
            }

            const url = window.location.href.split('#')[0] + '#' + encodeURIComponent(encoded);
            document.getElementById('shareUrl').value = url;
            document.getElementById('urlSection').classList.remove('hidden');
        }

        function copyShareUrl() {
            const url = document.getElementById('shareUrl').value;
            if (!url) {
                showNotification('Generate URL first', 'error');
                return;
            }
            navigator.clipboard.writeText(url).then(() => {
                showNotification('URL copied to clipboard');
            });
        }

        function openShareUrl() {
            const url = document.getElementById('shareUrl').value;
            if (!url) {
                showNotification('Generate URL first', 'error');
                return;
            }
            window.open(url, '_blank');
            showNotification('Opening URL in new tab');
        }

        function checkForSharedData() {
            const hash = window.location.hash.substring(1);
            if (!hash) return;

            try {
                const decoded = decodeURIComponent(hash);
                
                if (decoded.startsWith('enc:')) {
                    document.getElementById('decryptMessage').textContent = 'This URL contains an encrypted task list. Enter the password to decrypt it.';
                    document.getElementById('decryptPasswordSection').classList.remove('hidden');
                    el.decryptModal.classList.remove('hidden');
                } else if (decoded.startsWith('b64:')) {
                    document.getElementById('decryptMessage').textContent = 'This URL contains a shared task list. Click Load to import it.';
                    document.getElementById('decryptPasswordSection').classList.add('hidden');
                    el.decryptModal.classList.remove('hidden');
                } else {
                    document.getElementById('decryptMessage').textContent = 'This URL contains an encrypted task list. Enter the password to decrypt it.';
                    document.getElementById('decryptPasswordSection').classList.remove('hidden');
                    el.decryptModal.classList.remove('hidden');
                }
            } catch (e) {
                showNotification('Invalid share link', 'error');
                window.location.hash = '';
            }
        }

        function handleDecrypt() {
            const hash = window.location.hash.substring(1);
            if (!hash) return;

            try {
                const decoded = decodeURIComponent(hash);
                let imported;

                if (decoded.startsWith('enc:')) {
                    const password = document.getElementById('decryptPassword').value;
                    if (!password) {
                        showNotification('Please enter the password', 'error');
                        return;
                    }
                    const encrypted = decoded.substring(4);
                    const decrypted = CryptoJS.AES.decrypt(encrypted, password).toString(CryptoJS.enc.Utf8);
                    if (!decrypted) throw new Error('Invalid password');
                    imported = JSON.parse(decrypted);
                } else if (decoded.startsWith('b64:')) {
                    const base64 = decoded.substring(4);
                    imported = JSON.parse(atob(base64));
                } else {
                    const password = document.getElementById('decryptPassword').value;
                    if (!password) {
                        showNotification('Please enter the password', 'error');
                        return;
                    }
                    const decrypted = CryptoJS.AES.decrypt(decoded, password).toString(CryptoJS.enc.Utf8);
                    if (!decrypted) throw new Error('Invalid password');
                    imported = JSON.parse(decrypted);
                }

                state.tasks = imported;
                saveTasks();
                renderTasks();
                el.decryptModal.classList.add('hidden');
                window.location.hash = '';
                showNotification('Shared tasks loaded successfully');
            } catch (e) {
                showNotification('Failed to load: ' + e.message, 'error');
            }
        }

        function saveTasks() {
            localStorage.setItem('xsukax-tasks', JSON.stringify(state.tasks));
        }

        function showNotification(msg, type = 'success') {
            el.notificationText.textContent = msg;
            el.notification.className = `fixed top-4 right-4 px-4 py-3 rounded-md shadow-lg transition-all duration-300 max-w-sm z-50 ${type === 'error' ? 'bg-red-600' : 'bg-green-600'} text-white`;
            el.notification.classList.remove('translate-x-full');
            setTimeout(() => el.notification.classList.add('translate-x-full'), 3000);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatDate(date) {
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);
            const taskDate = new Date(date.getFullYear(), date.getMonth(), date.getDate());
            
            const time = date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            if (taskDate.getTime() === today.getTime()) return `Today, ${time}`;
            if (taskDate.getTime() === tomorrow.getTime()) return `Tomorrow, ${time}`;
            return date.toLocaleDateString() + ', ' + time;
        }

        function formatDateForInput(date) {
            const pad = n => String(n).padStart(2, '0');
            return `${date.getFullYear()}-${pad(date.getMonth() + 1)}-${pad(date.getDate())}T${pad(date.getHours())}:${pad(date.getMinutes())}`;
        }

        window.toggleSubtask = i => {
            const task = state.tasks.find(t => t.id === state.editingTaskId);
            if (task?.subtasks?.[i]) {
                task.subtasks[i].completed = !task.subtasks[i].completed;
                saveTasks();
                renderSubtasks(task.subtasks);
            }
        };

        window.updateSubtaskTitle = (i, title) => {
            const task = state.tasks.find(t => t.id === state.editingTaskId);
            if (task?.subtasks?.[i]) {
                task.subtasks[i].title = title;
                saveTasks();
            }
        };

        window.deleteSubtask = i => {
            const task = state.tasks.find(t => t.id === state.editingTaskId);
            if (task?.subtasks) {
                task.subtasks.splice(i, 1);
                saveTasks();
                renderSubtasks(task.subtasks);
            }
        };

        init();
    </script>
</body>
</html>
