<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>xsukax To-Do List</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
</head>
<body class="bg-gray-50 min-h-screen">
    <div id="app" class="container mx-auto px-4 py-8 max-w-4xl">
        <!-- Header -->
        <header class="flex justify-between items-center mb-8">
            <div class="flex items-center space-x-3">
                <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-white" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                    </svg>
                </div>
                <h1 class="text-2xl font-bold text-gray-800">xsukax To-Do List</h1>
            </div>
            <div class="flex space-x-2">
                <button id="importBtn" class="px-4 py-2 bg-white border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors">
                    Import
                </button>
                <button id="exportBtn" class="px-4 py-2 bg-white border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors">
                    Export
                </button>
                <button id="shareBtn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                    Share
                </button>
            </div>
        </header>

        <!-- Task Input -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 mb-6">
            <div class="flex items-start space-x-3">
                <button id="addTaskBtn" class="mt-1 w-6 h-6 rounded-full border-2 border-gray-300 flex items-center justify-center hover:border-blue-500 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                    </svg>
                </button>
                <input type="text" id="taskInput" placeholder="Add a new task..." class="flex-1 py-2 px-3 border-0 focus:outline-none focus:ring-0 text-lg">
                <button id="quickAddBtn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                    Add
                </button>
            </div>
            <div id="taskDetails" class="mt-4 hidden space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Due Date</label>
                        <input type="datetime-local" id="taskDueDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Priority</label>
                        <select id="taskPriority" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                            <option value="low">Low</option>
                            <option value="medium" selected>Medium</option>
                            <option value="high">High</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Tags (comma separated)</label>
                    <input type="text" id="taskTags" placeholder="work, personal, urgent" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Notes</label>
                    <textarea id="taskNotes" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"></textarea>
                </div>
                <div class="flex justify-end space-x-2">
                    <button id="cancelTaskBtn" class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
                        Cancel
                    </button>
                    <button id="saveTaskBtn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                        Save Task
                    </button>
                </div>
            </div>
        </div>

        <!-- Task Filters -->
        <div class="flex flex-wrap items-center justify-between mb-6">
            <div class="flex space-x-2 mb-2 md:mb-0">
                <button data-filter="all" class="filter-btn px-3 py-1 bg-blue-100 text-blue-700 rounded-lg text-sm font-medium">All</button>
                <button data-filter="today" class="filter-btn px-3 py-1 bg-white border border-gray-300 text-gray-700 rounded-lg text-sm font-medium hover:bg-gray-50">Today</button>
                <button data-filter="upcoming" class="filter-btn px-3 py-1 bg-white border border-gray-300 text-gray-700 rounded-lg text-sm font-medium hover:bg-gray-50">Upcoming</button>
                <button data-filter="completed" class="filter-btn px-3 py-1 bg-white border border-gray-300 text-gray-700 rounded-lg text-sm font-medium hover:bg-gray-50">Completed</button>
            </div>
            <div class="flex items-center space-x-2">
                <input type="text" id="searchInput" placeholder="Search tasks..." class="px-3 py-1 border border-gray-300 rounded-lg text-sm focus:ring-blue-500 focus:border-blue-500">
                <button id="clearSearch" class="p-1 text-gray-400 hover:text-gray-600">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                    </svg>
                </button>
            </div>
        </div>

        <!-- Tasks List -->
        <div id="tasksContainer" class="space-y-3">
            <!-- Tasks will be dynamically inserted here -->
        </div>

        <!-- Empty State -->
        <div id="emptyState" class="text-center py-12">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto text-gray-300 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
            <h3 class="text-lg font-medium text-gray-700 mb-1">No tasks yet</h3>
            <p class="text-gray-500">Get started by creating your first task.</p>
        </div>
    </div>

    <!-- Notification Overlay -->
    <div id="notification" class="fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg transition-all duration-300 transform translate-x-full">
        <div class="flex items-center space-x-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
            </svg>
            <span id="notificationText">Operation completed successfully</span>
        </div>
    </div>

    <!-- Modals -->
    <!-- Import Modal -->
    <div id="importModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-medium text-gray-900">Import Tasks</h3>
            </div>
            <div class="px-6 py-4">
                <textarea id="importData" rows="10" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="Paste your JSON data here"></textarea>
            </div>
            <div class="px-6 py-4 border-t border-gray-200 flex justify-end space-x-3">
                <button id="cancelImport" class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
                    Cancel
                </button>
                <button id="confirmImport" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                    Import
                </button>
            </div>
        </div>
    </div>

    <!-- Share Modal -->
    <div id="shareModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-medium text-gray-900">Share Task List</h3>
            </div>
            <div class="px-6 py-4 space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Encryption Password</label>
                    <input type="password" id="sharePassword" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="Enter a password to encrypt your data">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Shareable URL</label>
                    <div class="flex space-x-2">
                        <input type="text" id="shareUrl" readonly class="flex-1 px-3 py-2 border border-gray-300 rounded-lg bg-gray-50 text-gray-500">
                        <button id="copyUrlBtn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                            Copy
                        </button>
                    </div>
                </div>
            </div>
            <div class="px-6 py-4 border-t border-gray-200 flex justify-end">
                <button id="closeShareModal" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- Decrypt Modal -->
    <div id="decryptModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-medium text-gray-900">Decrypt Shared List</h3>
            </div>
            <div class="px-6 py-4">
                <p class="text-gray-600 mb-4">This URL contains an encrypted task list. Enter the password to decrypt it.</p>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                    <input type="password" id="decryptPassword" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="Enter the password">
                </div>
            </div>
            <div class="px-6 py-4 border-t border-gray-200 flex justify-end space-x-3">
                <button id="cancelDecrypt" class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
                    Cancel
                </button>
                <button id="confirmDecrypt" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                    Decrypt
                </button>
            </div>
        </div>
    </div>

    <!-- Task Detail Modal -->
    <div id="taskDetailModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                <h3 class="text-lg font-medium text-gray-900">Task Details</h3>
                <button id="closeTaskModal" class="text-gray-400 hover:text-gray-500">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div class="px-6 py-4 space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Title</label>
                    <input type="text" id="detailTitle" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-lg font-medium">
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Due Date</label>
                        <input type="datetime-local" id="detailDueDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Priority</label>
                        <select id="detailPriority" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                            <option value="low">Low</option>
                            <option value="medium">Medium</option>
                            <option value="high">High</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Tags</label>
                    <input type="text" id="detailTags" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="work, personal, urgent">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Notes</label>
                    <textarea id="detailNotes" rows="5" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Subtasks</label>
                    <div id="subtasksContainer" class="space-y-2 mb-3">
                        <!-- Subtasks will be added here -->
                    </div>
                    <div class="flex space-x-2">
                        <input type="text" id="newSubtask" placeholder="Add a subtask" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        <button id="addSubtaskBtn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                            Add
                        </button>
                    </div>
                </div>
            </div>
            <div class="px-6 py-4 border-t border-gray-200 flex justify-between">
                <button id="deleteTaskBtn" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors">
                    Delete Task
                </button>
                <div class="flex space-x-3">
                    <button id="cancelTaskDetail" class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
                        Cancel
                    </button>
                    <button id="saveTaskDetail" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                        Save Changes
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Application state
        const state = {
            tasks: JSON.parse(localStorage.getItem('xsukax-tasks')) || [],
            currentFilter: 'all',
            searchQuery: '',
            editingTaskId: null
        };

        // DOM Elements
        const elements = {
            taskInput: document.getElementById('taskInput'),
            tasksContainer: document.getElementById('tasksContainer'),
            emptyState: document.getElementById('emptyState'),
            notification: document.getElementById('notification'),
            notificationText: document.getElementById('notificationText'),
            importModal: document.getElementById('importModal'),
            exportBtn: document.getElementById('exportBtn'),
            importBtn: document.getElementById('importBtn'),
            shareBtn: document.getElementById('shareBtn'),
            shareModal: document.getElementById('shareModal'),
            decryptModal: document.getElementById('decryptModal'),
            taskDetailModal: document.getElementById('taskDetailModal'),
            filterBtns: document.querySelectorAll('.filter-btn'),
            searchInput: document.getElementById('searchInput'),
            clearSearch: document.getElementById('clearSearch'),
            addTaskBtn: document.getElementById('addTaskBtn'),
            quickAddBtn: document.getElementById('quickAddBtn'),
            taskDetails: document.getElementById('taskDetails'),
            cancelTaskBtn: document.getElementById('cancelTaskBtn'),
            saveTaskBtn: document.getElementById('saveTaskBtn'),
            taskDueDate: document.getElementById('taskDueDate'),
            taskPriority: document.getElementById('taskPriority'),
            taskTags: document.getElementById('taskTags'),
            taskNotes: document.getElementById('taskNotes')
        };

        // Initialize the application
        function init() {
            // Set up event listeners
            setupEventListeners();
            
            // Check if there's encrypted data in the URL
            checkForEncryptedData();
            
            // Render initial tasks
            renderTasks();
        }

        // Set up all event listeners
        function setupEventListeners() {
            // Task creation and management
            elements.addTaskBtn.addEventListener('click', toggleTaskDetails);
            elements.quickAddBtn.addEventListener('click', handleQuickAdd);
            elements.cancelTaskBtn.addEventListener('click', resetTaskForm);
            elements.saveTaskBtn.addEventListener('click', handleSaveTask);
            elements.taskInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    handleQuickAdd();
                }
            });

            // Filter and search
            elements.filterBtns.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const filter = e.target.dataset.filter;
                    setFilter(filter);
                });
            });
            
            elements.searchInput.addEventListener('input', (e) => {
                state.searchQuery = e.target.value;
                renderTasks();
            });
            
            elements.clearSearch.addEventListener('click', () => {
                elements.searchInput.value = '';
                state.searchQuery = '';
                renderTasks();
            });

            // Import/Export
            elements.importBtn.addEventListener('click', showImportModal);
            elements.exportBtn.addEventListener('click', handleExport);
            
            document.getElementById('cancelImport').addEventListener('click', () => {
                elements.importModal.classList.add('hidden');
            });
            
            document.getElementById('confirmImport').addEventListener('click', handleImport);

            // Sharing
            elements.shareBtn.addEventListener('click', showShareModal);
            document.getElementById('closeShareModal').addEventListener('click', () => {
                elements.shareModal.classList.add('hidden');
            });
            
            document.getElementById('copyUrlBtn').addEventListener('click', copyShareUrl);
            
            document.getElementById('cancelDecrypt').addEventListener('click', () => {
                elements.decryptModal.classList.add('hidden');
                // Clear the URL hash to prevent showing the modal again
                window.location.hash = '';
            });
            
            document.getElementById('confirmDecrypt').addEventListener('click', handleDecrypt);

            // Task detail modal
            document.getElementById('closeTaskModal').addEventListener('click', () => {
                elements.taskDetailModal.classList.add('hidden');
            });
            
            document.getElementById('cancelTaskDetail').addEventListener('click', () => {
                elements.taskDetailModal.classList.add('hidden');
            });
            
            document.getElementById('saveTaskDetail').addEventListener('click', saveTaskDetails);
            
            document.getElementById('deleteTaskBtn').addEventListener('click', deleteCurrentTask);
            
            document.getElementById('addSubtaskBtn').addEventListener('click', addSubtask);
            
            document.getElementById('newSubtask').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    addSubtask();
                }
            });
        }

        // Toggle task details form
        function toggleTaskDetails() {
            elements.taskDetails.classList.toggle('hidden');
            if (!elements.taskDetails.classList.contains('hidden')) {
                elements.taskInput.focus();
            }
        }

        // Handle quick add (title only)
        function handleQuickAdd() {
            const title = elements.taskInput.value.trim();
            if (!title) return;

            const newTask = {
                id: Date.now().toString(),
                title: title,
                completed: false,
                createdAt: new Date().toISOString(),
                priority: 'medium',
                tags: [],
                subtasks: [],
                notes: ''
            };

            state.tasks.unshift(newTask);
            saveTasks();
            renderTasks();
            elements.taskInput.value = '';
            showNotification('Task added successfully');
        }

        // Reset task form
        function resetTaskForm() {
            elements.taskInput.value = '';
            elements.taskDueDate.value = '';
            elements.taskPriority.value = 'medium';
            elements.taskTags.value = '';
            elements.taskNotes.value = '';
            elements.taskDetails.classList.add('hidden');
        }

        // Handle save task (with full details)
        function handleSaveTask() {
            const title = elements.taskInput.value.trim();
            if (!title) {
                showNotification('Please enter a task title', 'error');
                return;
            }

            const dueDate = elements.taskDueDate.value;
            const priority = elements.taskPriority.value;
            const tags = elements.taskTags.value.split(',').map(tag => tag.trim()).filter(tag => tag);
            const notes = elements.taskNotes.value;

            const newTask = {
                id: Date.now().toString(),
                title: title,
                completed: false,
                createdAt: new Date().toISOString(),
                dueDate: dueDate || null,
                priority: priority,
                tags: tags,
                subtasks: [],
                notes: notes
            };

            state.tasks.unshift(newTask);
            saveTasks();
            renderTasks();
            resetTaskForm();
            showNotification('Task added successfully');
        }

        // Set current filter
        function setFilter(filter) {
            state.currentFilter = filter;
            
            // Update active filter button
            elements.filterBtns.forEach(btn => {
                if (btn.dataset.filter === filter) {
                    btn.classList.remove('bg-white', 'border', 'border-gray-300', 'text-gray-700');
                    btn.classList.add('bg-blue-100', 'text-blue-700');
                } else {
                    btn.classList.remove('bg-blue-100', 'text-blue-700');
                    btn.classList.add('bg-white', 'border', 'border-gray-300', 'text-gray-700');
                }
            });
            
            renderTasks();
        }

        // Render tasks based on current filter and search
        function renderTasks() {
            let filteredTasks = [...state.tasks];
            
            // Apply search filter
            if (state.searchQuery) {
                const query = state.searchQuery.toLowerCase();
                filteredTasks = filteredTasks.filter(task => 
                    task.title.toLowerCase().includes(query) || 
                    task.tags.some(tag => tag.toLowerCase().includes(query)) ||
                    task.notes.toLowerCase().includes(query)
                );
            }
            
            // Apply status filter
            switch (state.currentFilter) {
                case 'today':
                    const today = new Date().toDateString();
                    filteredTasks = filteredTasks.filter(task => {
                        if (!task.dueDate) return false;
                        const dueDate = new Date(task.dueDate).toDateString();
                        return dueDate === today && !task.completed;
                    });
                    break;
                case 'upcoming':
                    const now = new Date();
                    filteredTasks = filteredTasks.filter(task => {
                        if (!task.dueDate || task.completed) return false;
                        const dueDate = new Date(task.dueDate);
                        return dueDate > now;
                    });
                    break;
                case 'completed':
                    filteredTasks = filteredTasks.filter(task => task.completed);
                    break;
                // 'all' filter shows all tasks
            }
            
            // Sort tasks: incomplete first, then by due date, then by creation date
            filteredTasks.sort((a, b) => {
                // Completed tasks go to the bottom
                if (a.completed && !b.completed) return 1;
                if (!a.completed && b.completed) return -1;
                
                // Then sort by due date (tasks without due date go to the bottom)
                if (a.dueDate && !b.dueDate) return -1;
                if (!a.dueDate && b.dueDate) return 1;
                if (a.dueDate && b.dueDate) {
                    const dateA = new Date(a.dueDate);
                    const dateB = new Date(b.dueDate);
                    if (dateA < dateB) return -1;
                    if (dateA > dateB) return 1;
                }
                
                // Finally sort by creation date (newest first)
                return new Date(b.createdAt) - new Date(a.createdAt);
            });
            
            // Render tasks or empty state
            if (filteredTasks.length === 0) {
                elements.tasksContainer.innerHTML = '';
                elements.emptyState.classList.remove('hidden');
            } else {
                elements.emptyState.classList.add('hidden');
                elements.tasksContainer.innerHTML = filteredTasks.map(task => renderTask(task)).join('');
                
                // Add event listeners to the rendered tasks
                filteredTasks.forEach(task => {
                    const taskElement = document.getElementById(`task-${task.id}`);
                    if (taskElement) {
                        // Complete toggle
                        const completeBtn = taskElement.querySelector('.complete-btn');
                        completeBtn.addEventListener('click', () => toggleTaskComplete(task.id));
                        
                        // Edit button
                        const editBtn = taskElement.querySelector('.edit-btn');
                        editBtn.addEventListener('click', () => openTaskDetail(task.id));
                        
                        // Delete button
                        const deleteBtn = taskElement.querySelector('.delete-btn');
                        deleteBtn.addEventListener('click', () => deleteTask(task.id));
                    }
                });
            }
        }

        // Render a single task
        function renderTask(task) {
            const dueDate = task.dueDate ? new Date(task.dueDate) : null;
            const isOverdue = dueDate && dueDate < new Date() && !task.completed;
            
            return `
                <div id="task-${task.id}" class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 ${task.completed ? 'opacity-70' : ''}">
                    <div class="flex items-start justify-between">
                        <div class="flex items-start space-x-3 flex-1">
                            <button class="complete-btn mt-1 w-5 h-5 rounded-full border-2 ${task.completed ? 'bg-blue-500 border-blue-500' : 'border-gray-300'} flex items-center justify-center hover:border-blue-500 transition-colors">
                                ${task.completed ? `
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 text-white" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                                    </svg>
                                ` : ''}
                            </button>
                            <div class="flex-1">
                                <h3 class="font-medium ${task.completed ? 'line-through text-gray-500' : 'text-gray-800'}">${escapeHtml(task.title)}</h3>
                                <div class="flex flex-wrap items-center mt-1 space-x-2">
                                    ${dueDate ? `
                                        <span class="text-xs px-2 py-1 rounded ${isOverdue ? 'bg-red-100 text-red-800' : 'bg-gray-100 text-gray-600'}">
                                            ${formatDate(dueDate)}
                                        </span>
                                    ` : ''}
                                    ${task.priority !== 'medium' ? `
                                        <span class="text-xs px-2 py-1 rounded ${task.priority === 'high' ? 'bg-red-100 text-red-800' : 'bg-blue-100 text-blue-800'}">
                                            ${task.priority === 'high' ? 'High Priority' : 'Low Priority'}
                                        </span>
                                    ` : ''}
                                    ${task.tags.map(tag => `
                                        <span class="text-xs px-2 py-1 rounded bg-gray-100 text-gray-600">
                                            ${escapeHtml(tag)}
                                        </span>
                                    `).join('')}
                                </div>
                                ${task.notes ? `
                                    <p class="text-sm text-gray-600 mt-2">${escapeHtml(task.notes)}</p>
                                ` : ''}
                                ${task.subtasks && task.subtasks.length > 0 ? `
                                    <div class="mt-2 text-sm text-gray-500">
                                        ${task.subtasks.filter(st => st.completed).length} of ${task.subtasks.length} subtasks completed
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                        <div class="flex space-x-1 ml-2">
                            <button class="edit-btn p-1 text-gray-400 hover:text-blue-500 transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" />
                                </svg>
                            </button>
                            <button class="delete-btn p-1 text-gray-400 hover:text-red-500 transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // Toggle task completion status
        function toggleTaskComplete(taskId) {
            const task = state.tasks.find(t => t.id === taskId);
            if (task) {
                task.completed = !task.completed;
                saveTasks();
                renderTasks();
                showNotification(`Task marked as ${task.completed ? 'completed' : 'incomplete'}`);
            }
        }

        // Open task detail modal
        function openTaskDetail(taskId) {
            const task = state.tasks.find(t => t.id === taskId);
            if (!task) return;
            
            state.editingTaskId = taskId;
            
            // Populate form fields
            document.getElementById('detailTitle').value = task.title;
            document.getElementById('detailDueDate').value = task.dueDate ? formatDateForInput(new Date(task.dueDate)) : '';
            document.getElementById('detailPriority').value = task.priority;
            document.getElementById('detailTags').value = task.tags.join(', ');
            document.getElementById('detailNotes').value = task.notes || '';
            
            // Render subtasks
            renderSubtasks(task.subtasks);
            
            // Show modal
            elements.taskDetailModal.classList.remove('hidden');
        }

        // Render subtasks in the detail modal
        function renderSubtasks(subtasks) {
            const container = document.getElementById('subtasksContainer');
            if (!subtasks || subtasks.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-sm">No subtasks yet</p>';
                return;
            }
            
            container.innerHTML = subtasks.map((subtask, index) => `
                <div class="flex items-center space-x-2">
                    <input type="checkbox" ${subtask.completed ? 'checked' : ''} 
                           onchange="toggleSubtask(${index}, ${state.editingTaskId})" 
                           class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                    <input type="text" value="${escapeHtml(subtask.title)}" 
                           class="flex-1 px-2 py-1 border border-gray-300 rounded focus:ring-blue-500 focus:border-blue-500 ${subtask.completed ? 'line-through text-gray-500' : ''}"
                           onchange="updateSubtaskTitle(${index}, ${state.editingTaskId}, this.value)">
                    <button onclick="deleteSubtask(${index}, ${state.editingTaskId})" class="text-red-500 hover:text-red-700">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 000-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                        </svg>
                    </button>
                </div>
            `).join('');
        }

        // Add a new subtask
        function addSubtask() {
            const input = document.getElementById('newSubtask');
            const title = input.value.trim();
            if (!title) return;
            
            const task = state.tasks.find(t => t.id === state.editingTaskId);
            if (!task) return;
            
            if (!task.subtasks) task.subtasks = [];
            
            task.subtasks.push({
                title: title,
                completed: false
            });
            
            saveTasks();
            renderSubtasks(task.subtasks);
            input.value = '';
        }

        // Save task details from the modal
        function saveTaskDetails() {
            const task = state.tasks.find(t => t.id === state.editingTaskId);
            if (!task) return;
            
            task.title = document.getElementById('detailTitle').value.trim();
            task.dueDate = document.getElementById('detailDueDate').value || null;
            task.priority = document.getElementById('detailPriority').value;
            task.tags = document.getElementById('detailTags').value.split(',').map(tag => tag.trim()).filter(tag => tag);
            task.notes = document.getElementById('detailNotes').value;
            
            saveTasks();
            renderTasks();
            elements.taskDetailModal.classList.add('hidden');
            showNotification('Task updated successfully');
        }

        // Delete the current task
        function deleteCurrentTask() {
            if (confirm('Are you sure you want to delete this task?')) {
                deleteTask(state.editingTaskId);
                elements.taskDetailModal.classList.add('hidden');
            }
        }

        // Delete a task
        function deleteTask(taskId) {
            state.tasks = state.tasks.filter(task => task.id !== taskId);
            saveTasks();
            renderTasks();
            showNotification('Task deleted successfully');
        }

        // Show import modal
        function showImportModal() {
            elements.importModal.classList.remove('hidden');
        }

        // Handle import
        function handleImport() {
            const importData = document.getElementById('importData').value.trim();
            if (!importData) {
                showNotification('Please enter JSON data to import', 'error');
                return;
            }
            
            try {
                const importedTasks = JSON.parse(importData);
                
                // Validate the imported data structure
                if (!Array.isArray(importedTasks)) {
                    throw new Error('Imported data must be an array of tasks');
                }
                
                // Merge with existing tasks (avoid duplicates by ID)
                const existingIds = new Set(state.tasks.map(task => task.id));
                const newTasks = importedTasks.filter(task => !existingIds.has(task.id));
                
                state.tasks = [...state.tasks, ...newTasks];
                saveTasks();
                renderTasks();
                
                elements.importModal.classList.add('hidden');
                showNotification(`Imported ${newTasks.length} tasks successfully`);
            } catch (error) {
                showNotification('Invalid JSON data: ' + error.message, 'error');
            }
        }

        // Handle export
        function handleExport() {
            const dataStr = JSON.stringify(state.tasks, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = 'xsukax-tasks.json';
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            
            showNotification('Tasks exported successfully');
        }

        // Show share modal
        function showShareModal() {
            elements.shareModal.classList.remove('hidden');
            document.getElementById('sharePassword').value = '';
            document.getElementById('shareUrl').value = '';
        }

        // Generate and copy share URL
        function copyShareUrl() {
            const password = document.getElementById('sharePassword').value;
            if (!password) {
                showNotification('Please enter a password to encrypt your data', 'error');
                return;
            }
            
            // Encrypt the tasks data
            const encrypted = CryptoJS.AES.encrypt(JSON.stringify(state.tasks), password).toString();
            
            // Create URL with encrypted data
            const baseUrl = window.location.href.split('#')[0];
            const shareUrl = `${baseUrl}#${encodeURIComponent(encrypted)}`;
            
            document.getElementById('shareUrl').value = shareUrl;
            
            // Copy to clipboard
            navigator.clipboard.writeText(shareUrl).then(() => {
                showNotification('Shareable URL copied to clipboard');
            });
        }

        // Check for encrypted data in URL
        function checkForEncryptedData() {
            const hash = window.location.hash.substring(1);
            if (hash) {
                // Show decrypt modal
                elements.decryptModal.classList.remove('hidden');
            }
        }

        // Handle decrypt
        function handleDecrypt() {
            const password = document.getElementById('decryptPassword').value;
            const hash = window.location.hash.substring(1);
            
            if (!password) {
                showNotification('Please enter the password', 'error');
                return;
            }
            
            try {
                // Decrypt the data
                const decrypted = CryptoJS.AES.decrypt(decodeURIComponent(hash), password).toString(CryptoJS.enc.Utf8);
                
                if (!decrypted) {
                    throw new Error('Invalid password or corrupted data');
                }
                
                const importedTasks = JSON.parse(decrypted);
                
                // Replace current tasks with imported ones
                state.tasks = importedTasks;
                saveTasks();
                renderTasks();
                
                elements.decryptModal.classList.add('hidden');
                // Clear the URL hash
                window.location.hash = '';
                
                showNotification('Shared task list imported successfully');
            } catch (error) {
                showNotification('Decryption failed: ' + error.message, 'error');
            }
        }

        // Save tasks to localStorage
        function saveTasks() {
            localStorage.setItem('xsukax-tasks', JSON.stringify(state.tasks));
        }

        // Show notification
        function showNotification(message, type = 'success') {
            elements.notificationText.textContent = message;
            
            // Set background color based on type
            if (type === 'error') {
                elements.notification.classList.remove('bg-green-500');
                elements.notification.classList.add('bg-red-500');
            } else {
                elements.notification.classList.remove('bg-red-500');
                elements.notification.classList.add('bg-green-500');
            }
            
            // Show notification
            elements.notification.classList.remove('translate-x-full');
            
            // Hide after 3 seconds
            setTimeout(() => {
                elements.notification.classList.add('translate-x-full');
            }, 3000);
        }

        // Utility functions
        function escapeHtml(unsafe) {
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        function formatDate(date) {
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);
            
            const taskDate = new Date(date.getFullYear(), date.getMonth(), date.getDate());
            
            if (taskDate.getTime() === today.getTime()) {
                return `Today, ${date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`;
            } else if (taskDate.getTime() === tomorrow.getTime()) {
                return `Tomorrow, ${date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`;
            } else {
                return date.toLocaleDateString() + ', ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            }
        }

        function formatDateForInput(date) {
            // Convert to format YYYY-MM-DDTHH:MM
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            
            return `${year}-${month}-${day}T${hours}:${minutes}`;
        }

        // Global functions for subtask management (called from inline event handlers)
        window.toggleSubtask = function(index, taskId) {
            const task = state.tasks.find(t => t.id === taskId);
            if (task && task.subtasks && task.subtasks[index]) {
                task.subtasks[index].completed = !task.subtasks[index].completed;
                saveTasks();
                renderSubtasks(task.subtasks);
            }
        };

        window.updateSubtaskTitle = function(index, taskId, newTitle) {
            const task = state.tasks.find(t => t.id === taskId);
            if (task && task.subtasks && task.subtasks[index]) {
                task.subtasks[index].title = newTitle;
                saveTasks();
            }
        };

        window.deleteSubtask = function(index, taskId) {
            const task = state.tasks.find(t => t.id === taskId);
            if (task && task.subtasks) {
                task.subtasks.splice(index, 1);
                saveTasks();
                renderSubtasks(task.subtasks);
            }
        };

        // Initialize the app
        init();
    </script>
</body>
</html>